<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="UTF-8">
	<title>Ansicht Depot</title>
	<link rel="stylesheet" type="text/css" href="css/depot.css">
	<style>

.col_Cookie,.col_Passwort,.col_ErstellZeitpunkt,.col_AenderZeitpunkt,.col_AenderBenutzer_ID,.col_wpaccount_status,
.col_wpfirst_name,.col_wpsession_tokens,.col_wpuser_login,.col_wpuser_nicename,.col_wpuser_pass,
.col_wpuser_activation_key,.col_wpuser_registered,.col_wpuser_status,.col_wpuser_url,.col_wpwp_user_level { display: none;}

select.editor.inp_Depot_ID, select.editor.inp_Role_ID, input.editor.inp_Passwort,
	input.editor.inp_Cookie, input.editor.inp_PunkteStand, select.editor.inp_PunkteWoche,
	table.Benutzer td.col_BenutzerAbo td.col_Woche, .BenutzerBestellView .col_Benutzer_ID,
	.BenutzerBestellView .col_Depot_ID, .BenutzerBestellView .col_Produkt_ID,
	.DepotBestellView .col_Depot_ID, .DepotBestellView .col_Produkt_ID,
	.GesamtBestellView .col_Produkt_ID, .BenutzerView .col_Depot_ID,
	.BenutzerView .col_Role_ID, .BenutzerBestellungView .col_Benutzer_ID,
	.BenutzerBestellungView .col_Depot_ID, .BenutzerBestellungView .col_Produkt_ID {
	display: inline-block !important;
}
</style>
	<script src="js/util.js"></script>
	<script src="js/weekSelect.js"></script>
	<script src="js/solawiBestellSystem.js"></script>
	<script src="js/solawiValidator.js"></script>
	<script src="js/memberEditor.js"></script>
	<script src="js/solawiEditor.js"></script>
	<script src="js/solawiTableEditor.js"></script>
	<script src="js/solawiTableVerwalter.js"></script>
	<script src="js/solawiTable.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/exceljs@1.13.0/dist/exceljs.min.js"></script>
	<script type="text/javascript" src="lib/FileSaver.min.js"></script>
</head>
<body style="background-color:#FFF;">

	<script src="js/ui.js"></script>

	<script>
    var SBTedit = SolawiTable(SBS, 'table', 'tablePath', '2', false);
    var SBTview = SolawiTable(SBS, 'table', 'tablePath', false, false);
    SBTview.hideZeros = true;

        function loadTableBenutzer(){getAjax('wp', function (response, path) {
            var byWpId = {};
	        for (var j = 0; j < response.length; j++) {
				byWpId[response[j].ID] = response[j];
	        }
		    getAjax('Benutzer', function(response2, path2) {
		        for (var i = 0; i < response2.length; i++) {
		            var usr = response2[i];
		            usr.NOTES = '';
		            if (usr.wpID) {
		                var wpUsr = byWpId[usr.wpID];
		                if (wpUsr) {
			            		Object.keys(wpUsr).forEach(function(key) {
			            		   usr['wp'+key]=wpUsr[key];
			            		});
			            		if (wpUsr.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpUsr.wpSynced = 1;
		                }
		            }
		            if (usr.wpMitID) {
		                var wpMit = byWpId[usr.wpMitID]
		                if (wpMit) {
			            		usr.wpMitName = wpMit.display_name;
			            		if (wpMit.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpMit.wpSynced = 1;
			            		if (usr.Depot_ID && wpMit.Depot) {
				            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
				            		if (depot && wpMit.Depot != depot.wpName && !(wpMit.Depot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
										usr.NOTES += ' !MIT_DEPOT! ';
				            		}
			            		}
		                }
		            	if (!usr.wpMitName) {
							usr.NOTES += ' !MISS_WP_MIT! ';
		            	} else if ((!usr.MitName) || usr.wpMitName.toLowerCase() != usr.MitName.toLowerCase()) {
							usr.NOTES += ' !MIT_NAME! ';
		            	}
		            } else {
		                usr.wpMitName = '';
		                if (usr.MitName) {
							usr.NOTES += ' !NO_WP_MIT! ';
		                }
		            }
		            if (usr.wpMit2ID) {
		                var wpMit2 = byWpId[usr.wpMit2ID]
		                if (wpMit2) {
			            		usr.wpMit2Name = wpMit2.display_name;
			            		if (wpMit2.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpMit2.wpSynced = 1;
			            		if (usr.Depot_ID && wpMit2.Depot) {
				            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
				            		if (depot && wpMit2.Depot != depot.wpName && !(wpMit2.Depot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
										usr.NOTES += ' !MIT2_DEPOT! ';
				            		}
			            		}
		                }
		            	if (!usr.wpMit2Name) {
							usr.NOTES += ' !MISS_WP2_MIT! ';
		            	} else if ((!usr.Mit2Name) || usr.wpMit2Name.toLowerCase() != usr.Mit2Name.toLowerCase()) {
							usr.NOTES += ' !MIT2_NAME! ';
		            	}
		            	
		            } else {
		                usr.wpMit2Name = '';
		                if (usr.Mit2Name) {
							usr.NOTES += ' !NO_WP_MIT2! ';
		                }
		            }
		            if (usr.wpMit3ID) {
		                var wpMit3 = byWpId[usr.wpMit3ID]
		                if (wpMit3) {
			            		usr.wpMit3Name = wpMit3.display_name;
			            		if (wpMit3.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpMit3.wpSynced = 1;
			            		if (usr.Depot_ID && wpMit3.Depot) {
				            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
				            		if (depot && wpMit3.Depot != depot.wpName && !(wpMit3.Depot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
										usr.NOTES += ' !Mit3_DEPOT! ';
				            		}
			            		}
		                }
		            	if (!usr.wpMit3Name) {
							usr.NOTES += ' !MISS_WP2_MIT! ';
		            	} else if ((!usr.Mit3Name) || usr.wpMit3Name.toLowerCase() != usr.Mit3Name.toLowerCase()) {
							usr.NOTES += ' !Mit3_NAME! ';
		            	}
		            	
		            } else {
		                usr.wpMit3Name = '';
		                if (usr.Mit3Name) {
							usr.NOTES += ' !NO_WP_Mit3! ';
		                }
		            }
		            if (!usr.wpID) {
		                usr.NOTES += ' !NO_WP! ';
		            } else {
		                if (!usr.wpdisplay_name) {
							usr.NOTES += ' !MISS_WP! ';
		                } else if ((!usr.Name) || usr.wpdisplay_name.toLowerCase() != usr.Name.toLowerCase()) {
							usr.NOTES += ' !NAME! ';
	            		}
	            		if (usr.Depot_ID && usr.wpDepot) {
		            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
		            		if (depot && usr.wpDepot != depot.wpName && !(usr.wpDepot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
								usr.NOTES += ' !DEPOT! ';
		            		}
	            		}
		            }
		        }
		        var depotFilter = document.getElementById('depotFilter');
		        var depotObj = depotFilter && depotFilter.value && SBS.tableCache['Depot'] && SBS.tableCache['Depot'][depotFilter.value];
		        var wpDepot = depotObj && depotObj.wpName;
		        for (var j = 0; j < response.length; j++) {
		            var wpUsr = response[j];
					if (!wpUsr.wpSynced) {
	            		if ((!wpDepot) || wpUsr.Depot == wpDepot || (wpUsr.Depot == 'Hofteam' && wpDepot == 'Selbstabholer')) {
						    var usr = {ID: -1, Name:'onlyWP'};
		            		Object.keys(wpUsr).forEach(function(key) {
		        		    		usr['wp'+key]=wpUsr[key];
				            		});
		            		response2.push(usr);
	            		}
					}
		        }
				/* filter users by depot at the very end. Needs to be done at the end, because assignment needs to be done first */
				var response3 = response2;
				response2 = [];
				for (var j = 0; j<response3.length;j++) {
					if(response3[j] && depotFilter && ((response3[j].Depot_ID !== 0 && !response3[j].Depot_ID) || (depotFilter.value !== '' && depotFilter.value == response3[j]['Depot_ID']) ) ) {
					    response2.push(response3[j]);
					}
					else if(response3[j] && (response3[j].Depot_ID !== 0) && ((!depotFilter) || depotFilter.value === '') ) {
					    response2.push(response3[j]);
					}
				}

		        var btn = document.getElementById('pivotBtn');
		        if (btn) {
		            btn.innerText = 'Bestellübersicht ' + ( (depotObj && depotObj.Name) || 'Solawi');
		        }
		        var filterContainer = document.getElementById('filterContainer');
				if (filterContainer && (!document.getElementById('depotFilter')) && SBTedit && SBS.tableCache['Depot']) {
					inp = createInputSelect(SBS.tableCache['Depot']);
					filterContainer.appendChild(inp);
					inp.onchange = SBTedit.reload;
					inp.id = 'depotFilter';
					inp.value = '';
					var opt = document.createElement("OPTION");
					opt.value='';
					opt.innerText='Zeige alle Depots außer "Geloescht"';
					opt.selected='selected';
					inp.appendChild(opt);
				}

				SBTedit.showTable(response2, path2);
		    });
        });}

        SBTedit.setSortBy('Name');
		SBTedit.editAtOnce = true;

		initUser(function() {
	        if (SBS.user.Role_ID > 3) {
				SBTedit.reload=loadTableBenutzer;
		        SBTedit.columns = ['Name','wplast_name','Depot_ID','Anteile','FleischAnteile','AnteileStartWoche','PunkteStart','PunkteStand','PunkteWoche','Role_ID','_Beitrag','_IBAN','NOTES','wpID','wpMitID','wpMit2ID','wpMit3ID','wpBeruf_10','wpBeruf_10_11','wpStrasse','wpdescription','wpBeruf','wpMitarbeit-bei','wprole','wpuser_email','wpdisplay_name','wpMitMitgliedvon','wpMitName','MitName','AltName','wpDepot'];
		        loadTableBenutzer();
	        } else {
	            SBTedit.reload=function(){getAjax('Benutzer', SBTedit.showTable);};
	            SBTedit.columns = ['Name','Depot_ID','Anteile','FleischAnteile','AnteileStartWoche','PunkteStart','PunkteStand','PunkteWoche','MitName','AltName'];
	            SBTedit.reload();
		        var filterContainer = document.getElementById('filterContainer');
				var btn = document.createElement('button');
				btn.innerText='Depot-Bestellung';
				btn.onclick=function() {
				    SBTedit.reset();
				    getAjax('PivotDepotBestellung/Woche/' + SBS.selectedWeek + '/Depot_ID/' + SBS.user.Depot_ID , SBTview.showTable);
				    document.getElementById('pivotBtn').innerText="Mitglieder-Liste";
				};
				filterContainer.appendChild(btn);
            }
		});

		var filterContainer = document.getElementById('filterContainer');
		if (filterContainer && SBTedit) {
	        inp = createInputSelect(sbs.tableCache['Depot']);
	        filterContainer.appendChild(inp);
	        inp.onChange = SBTedit.reload;
	    }

		function createInputSelect(response){
		    var inp = document.createElement("SELECT");
		    if (response.slice && response.sort && response.length > 0) {
		    	response = response.slice();
		        if ((response[0] && response[0]['Nr']) || (response.length > 1 && response[1] && response[1]['Nr'])) {
		            response.sort( function rowSortFunc(a,b) { return a['Nr'] < b['Nr'] ? -1 : a['Nr'] > b['Nr'] ? 1 : 0; } );
		        } else {
		            response.sort( function rowSortFunc(a,b) { return a['Name'] < b['Name'] ? -1 : a['Name'] > b['Name'] ? 1 : 0; } );
		        }
		    }
		    for (var k=0; k<response.length; k++) {
		        var row = response[k];
		        if (row) {
			        var opt = document.createElement("OPTION");
			        opt.value=row.ID;
			        opt.innerText=row.Name;
			        inp.appendChild(opt);
		        }
		    }
		    return inp;
		}

        function changeWeek(count) {
            SBS.selectedWeek = addWeek(SBS.selectedWeek, count);
            setHtmlContent('selectedWeek0', '<span title="weekToDate(SBS.selectedWeek, 4).toLocaleDateString()">' +  SBS.selectedWeek + '</span>');
            if (SBTview.getTableName() && SBTview.getTablePath()) {
                if (SBTview.getTablePath().match(/PivotDepotBestellung.Woche.[0-9.]+.Depot_ID.[0-9]+/)) {
                    getAjax(SBTview.getTablePath().replace(/Woche.[0-9.]+/, 'Woche/'+SBS.selectedWeek), SBTview.showTable) ;
                } else if (SBTview.getTablePath().match(/.*Pivot.*/)) {
                    getAjax(SBTview.getTableName() + '/' + SBS.selectedWeek, SBTview.showTable);
                }
           }
        }
    </script>

	<div id="tableContainer">

		<div id="filterContainer" style="margin-right: 250px;">
			<a style="float:right;" href="index.htm">zurück zur Startseite</a>
			<button onclick="SBTview.reset();getAjax('BenutzerPunkte/NULL', SBTedit.reload)">Punkte_Berechnen</button>
			<button	id="pivotBtn" onclick="if (event.target.innerText == 'Mitglieder-Liste' ) {event.target.innerText='Bestellübersicht';SBTview.reset();SBTedit.reload();} else {event.target.innerText = 'Mitglieder-Liste';SBTedit.reset();var ele = document.getElementById('depotFilter');getAjax((ele && ele.value ? 'PivotDepotBestellung/Woche/' : 'PivotSolawiBestellung/') + SBS.selectedWeek + (ele && ele.value ? '/Depot_ID/' + ele.value : ''), SBTview.showTable);}">Bestellübersicht</button>
			&#160; &#160; &#160; | &#160; &#160;  MITGLIEDER-VERWALTUNG &#160; &#160; &#160; Depot:
		</div>

		<div id="tablePath"></div>
		<div class="fixedHeaderTable">
			<table id="table" cellspacing="0">
			</table>
		</div>

		<br /> <br /> <br />

	</div>

</body>
</html>
