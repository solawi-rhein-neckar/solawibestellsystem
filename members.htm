<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="UTF-8">
	<title>Ansicht Depot</title>
	<link rel="stylesheet" type="text/css" href="css/depot.css">
	<style>

.col_Cookie,.col_Passwort,.col_ErstellZeitpunkt,.col_AenderZeitpunkt,.col_AenderBenutzer_ID,.col_wpaccount_status,
.col_wpfirst_name,.col_wplast_name,.col_wpsession_tokens,.col_wpuser_login,.col_wpuser_nicename,.col_wpuser_pass,
.col_wpuser_activation_key,.col_wpuser_registered,.col_wpuser_status,.col_wpuser_url,.col_wpwp_user_level { display: none;}

select.editor.inp_Depot_ID, select.editor.inp_Role_ID, input.editor.inp_Passwort,
	input.editor.inp_Cookie, input.editor.inp_PunkteStand, select.editor.inp_PunkteWoche,
	table.Benutzer td.col_BenutzerAbo td.col_Woche, .BenutzerBestellView .col_Benutzer_ID,
	.BenutzerBestellView .col_Depot_ID, .BenutzerBestellView .col_Produkt_ID,
	.DepotBestellView .col_Depot_ID, .DepotBestellView .col_Produkt_ID,
	.GesamtBestellView .col_Produkt_ID, .BenutzerView .col_Depot_ID,
	.BenutzerView .col_Role_ID, .BenutzerBestellungView .col_Benutzer_ID,
	.BenutzerBestellungView .col_Depot_ID, .BenutzerBestellungView .col_Produkt_ID {
	display: inline-block !important;
}
</style>
	<script src="js/util.js"></script>
	<script src="js/weekSelect.js"></script>
	<script src="js/solawiBestellSystem.js"></script>
	<script src="js/solawiValidator.js"></script>
	<script src="js/memberEditor.js"></script>
	<script src="js/solawiEditor.js"></script>
	<script src="js/solawiTableEditor.js"></script>
	<script src="js/solawiTableVerwalter.js"></script>
	<script src="js/solawiTable.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/exceljs@1.13.0/dist/exceljs.min.js"></script>
	<script type="text/javascript" src="lib/FileSaver.min.js"></script>
</head>
<body>

	<script src="js/ui.js"></script>

	<script>
        var SBTedit = SolawiTable(SBS, 'table', 'tablePath', '2', false);

        function loadTableBenutzer(){getAjax('/cgi-bin/wp.pl/', function (response, path) {
            var byWpId = {};
	        for (var j = 0; j < response.length; j++) {
				byWpId[response[j].ID] = response[j];
	        }
	        var depotFilter = document.getElementById('depotFilter');
		    getAjax(depotFilter && (depotFilter.value === '0' || depotFilter.value === 0) ? 'Benutzer' : ('Benutzer/' + (depotFilter && depotFilter.value ? ('Depot_ID/' + depotFilter.value) : 'ACTIVE')), function(response2, path2) {
		        for (var i = 0; i < response2.length; i++) {
		            var usr = response2[i];
		            usr.NOTES = '';
		            if (usr.wpID) {
		                var wpUsr = byWpId[usr.wpID];
		                if (wpUsr) {
			            		Object.keys(wpUsr).forEach(function(key) {
			            		   usr['wp'+key]=wpUsr[key];
			            		});
			            		if (wpUsr.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpUsr.wpSynced = 1;
		                }
		            }
		            if (usr.wpMitID) {
		                var wpMit = byWpId[usr.wpMitID]
		                if (wpMit) {
			            		usr.wpMitName = wpMit.display_name;
			            		if (wpMit.wpSynced) {
			            		   usr.NOTES += ' !DUP_SYNC! ';
			            		}
			            		wpMit.wpSynced = 1;
			            		if (usr.Depot_ID && wpMit.Depot) {
				            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
				            		if (depot && wpMit.Depot != depot.wpName && !(wpMit.Depot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
										usr.NOTES += ' !MIT_DEPOT! ';
				            		}
			            		}
		                }
		            	if (!usr.wpMitName) {
							usr.NOTES += ' !MISS_WP_MIT! ';
		            	} else if ((!usr.MitName) || usr.wpMitName.toLowerCase() != usr.MitName.toLowerCase()) {
							usr.NOTES += ' !MIT_NAME! ';
		            	}
		            } else {
		                usr.wpMitName = '';
		                if (usr.MitName) {
							usr.NOTES += ' !NO_WP_MIT! ';
		                }
		            }
		            if (!usr.wpID) {
		                usr.NOTES += ' !NO_WP! ';
		            } else {
		                if (!usr.wpdisplay_name) {
							usr.NOTES += ' !MISS_WP! ';
		                } else if ((!usr.Name) || usr.wpdisplay_name.toLowerCase() != usr.Name.toLowerCase()) {
							usr.NOTES += ' !NAME! ';
	            		}
	            		if (usr.Depot_ID && usr.wpDepot) {
		            		var depot = SBS.tableCache['Depot'][usr.Depot_ID];
		            		if (depot && usr.wpDepot != depot.wpName && !(usr.wpDepot == 'Hofteam' && depot.wpName == 'Selbstabholer')) {
								usr.NOTES += ' !DEPOT! ';
		            		}
	            		}
		            }
		        }
		        var wpDepot = depotFilter && depotFilter.value && SBS.tableCache['Depot'] && SBS.tableCache['Depot'][depotFilter.value] && SBS.tableCache['Depot'][depotFilter.value].wpName;
		        for (var j = 0; j < response.length; j++) {
		            var wpUsr = response[j];
					if (!wpUsr.wpSynced) {
	            		if ((!wpDepot) || wpUsr.Depot == wpDepot || (wpUsr.Depot == 'Hofteam' && wpDepot == 'Selbstabholer')) {
						    var usr = {ID: -1, Name:'onlyWP'};
		            		Object.keys(wpUsr).forEach(function(key) {
		        		    		usr['wp'+key]=wpUsr[key];
				            		});
		            		response2.push(usr);
	            		}
					}
		        }
		  		  var filterContainer = document.getElementById('filterContainer');
		  		  if (filterContainer && (!document.getElementById('depotFilter')) && SBTedit && SBS.tableCache['Depot']) {
		  	          inp = createInputSelect(SBS.tableCache['Depot']);
		  	          filterContainer.appendChild(inp);
		  	          inp.onchange = SBTedit.reload;
		  	          inp.id = 'depotFilter';
		  	          inp.value = '';
				        var opt = document.createElement("OPTION");
				        opt.value='';
				        opt.innerText='Zeige alle Depots außer "Geloescht"';
				        opt.selected='selected';
				        inp.appendChild(opt);
		  	      }
		  		  if (depotFilter && (depotFilter.value === '0' || depotFilter.value === 0)) {
		  		    var response3 = response2;
		  		    response2 = [];
					for (var j = 0; j<response3.length;j++) {
					    console.log(response3[j]);
					    if(response3[j] && (!response3[j].Depot_ID)) {
					        response2.push(response3[j]);
					    }
					}
		  		  }
		        SBTedit.showTable(response2, path2);
		    });
        });}

		SBTedit.reload=loadTableBenutzer;
        SBTedit.setSortBy('Name');
        SBTedit.columns = ['Name','MitName','Depot_ID','Anteile','FleischAnteile','AnteileStartWoche','PunkteStart','PunkteStand','PunkteWoche','Role_ID','_Beitrag','_IBAN','NOTES','wpID','wpMitID','wpuser_email','wpBeruf','wpBeruf_10','wpBeruf_10_11','wpMitarbeit-bei','wpStrasse','wpdescription','wprole','wpdisplay_name','wpMitMitgliedvon','wpMitName','AltName','wpDepot'];
		SBTedit.editAtOnce = true;

		initUser(loadTableBenutzer);

		var filterContainer = document.getElementById('filterContainer');
		if (filterContainer && SBTedit) {
	        inp = createInputSelect(sbs.tableCache['Depot']);
	        filterContainer.appendChild(inp);
	        inp.onChange = SBTedit.reload;
	    }

		function createInputSelect(response){
		    var inp = document.createElement("SELECT");
		    if (response.slice && response.sort && response.length > 0) {
		    	response = response.slice();
		        if ((response[0] && response[0]['Nr']) || (response.length > 1 && response[1] && response[1]['Nr'])) {
		            response.sort( function rowSortFunc(a,b) { return a['Nr'] < b['Nr'] ? -1 : a['Nr'] > b['Nr'] ? 1 : 0; } );
		        } else {
		            response.sort( function rowSortFunc(a,b) { return a['Name'] < b['Name'] ? -1 : a['Name'] > b['Name'] ? 1 : 0; } );
		        }
		    }
		    for (var k=0; k<response.length; k++) {
		        var row = response[k];
		        if (row) {
			        var opt = document.createElement("OPTION");
			        opt.value=row.ID;
			        opt.innerText=row.Name;
			        inp.appendChild(opt);
		        }
		    }
		    return inp;
		}

        function changeWeek(count) {
            SBS.selectedWeek = addWeek(SBS.selectedWeek, count);
            setHtmlContent('selectedWeek0', '<span title="weekToDate(SBS.selectedWeek, 4).toLocaleDateString()">' +  SBS.selectedWeek + '</span>');
        }
    </script>

	<div id="tableContainer">

		<div style="text-align: center; padding: 5px 0 10px 0; white-space: nowrap; overflow: hidden; width: 80%;">
			MITGLIEDER-VERWALTUNG &#160; - &#160; <a href="index.htm">zurück zur Startseite</a>
		</div>

		<div id="filterContainer">FILTER: Depot:</div>

		<div id="tablePath"></div>
		<div class="fixedHeaderTable">
			<table id="table" cellspacing="0">
			</table>
		</div>

		<br /> <br /> <br />

	</div>

</body>
</html>
